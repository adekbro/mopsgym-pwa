<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MopsGym (z Zapisem Lokalnym)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        body { background-color: #1c1917; }
        .font-mono { font-family: 'VT323', monospace; }
        .font-header { font-family: 'Press Start 2P', cursive; }
        .pixel-corners { border-radius: 8px; }
        .pixel-button { font-family: 'Press Start 2P', cursive; padding: 10px 16px; border: 4px solid #1c1917; box-shadow: 4px 4px 0px #1c1917; transition: all 0.1s; text-transform: uppercase; font-size: 10px; cursor: pointer; }
        .pixel-button:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1c1917; }
        .pixel-button:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0px #1c1917; }
        .pixel-button:disabled { cursor: not-allowed; background-color: #a8a29e !important; color: #e7e5e4 !important; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-2%); } 50% { transform: translateY(0); } }
        .animate-bounce-slow { animation: bounce-slow 3s ease-in-out infinite; }
    </style>
  <link rel="manifest" href="manifest.json">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Wbudowane komponenty ikon SVG ---
        const createIcon = (svg) => (props) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                {...props}
            >
                {svg}
            </svg>
        );

        const ArrowLeft = createIcon(<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>);
        const CheckSquare = createIcon(<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>);
        const Square = createIcon(<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>);
        const BarChart2 = createIcon(<><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></>);
        const Undo2 = createIcon(<><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></>);
        const Flame = createIcon(<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>);

        // --- Static Messages (Offline Version) ---
        const messages = {
            congrats: [ "Brawo! Jeste≈õ jak mopso-Rambo!", "Klatka wbita. Dobrze jest!", "Jestem z ciebie dum(mops)ny.", "Zrobi≈Çe≈õ nogi?! O m√≥j psi ogon, jeste≈õ potworem üêæüí•", "Nie wiem co bardziej napakowane ‚Äì ty czy moja miska z karmƒÖ." ],
            motivation: [ "Nie zrobi≈Çe≈õ? Serio? Nawet mops nie ma tak kr√≥tkiej motywacji.", "Zawiod≈Çe≈õ mopsa... ale zawsze mo≈ºesz zaczƒÖƒá od nowa!", "Hej ziomek, trening zrobiony czy znowu symulujesz kontuzjƒô? üòé", "Mops gotowy na pompki. Ty te≈º?", "Jeszcze nie ƒáwiczy≈Çe≈õ. Nie wstyd≈∫ siƒô przed mopsem." ],
        };
        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

        // --- Training Plans & Logic ---
        const trainingPlans = {
            reduction: [ { day: 1, name: "Klatka + Triceps", mainLift: "Wyciskanie sztangi poziomo", exercises: [{ name: "Wyciskanie sztangi poziomo", sets: "4", reps: "10-15", p: 0.65 }, { name: "Wyciskanie hantli skos", sets: "4", reps: "10-15", p: 0.50 }, { name: "Rozpiƒôtki", sets: "4", reps: "10-15", p: 0.30 }, { name: "Dipy (pompki na porƒôczach)", sets: "4", reps: "10-15" }, { name: "Prostowanie ramion na wyciƒÖgu", sets: "4", reps: "10-15" }] }, { day: 2, name: "Plecy + Biceps", mainLift: "Martwy ciƒÖg klasyczny", exercises: [{ name: "Martwy ciƒÖg klasyczny", sets: "4", reps: "10-15", p: 0.65 }, { name: "Wios≈Çowanie sztangƒÖ", sets: "4", reps: "10-15", p: 0.55 }, { name: "≈öciƒÖganie drƒÖ≈ºka do klatki", sets: "4", reps: "10-15" }, { name: "Uginanie ramion ze sztangƒÖ", sets: "4", reps: "10-15", p: 0.30 }, { name: "M≈Çotki hantlami", sets: "4", reps: "10-15" }] }, { day: 3, name: "Nogi", mainLift: "Przysiady ze sztangƒÖ", exercises: [{ name: "Przysiady ze sztangƒÖ", sets: "4", reps: "10-15", p: 0.65 }, { name: "Wykroki", sets: "4", reps: "10-15", p: 0.40 }, { name: "Prostowanie n√≥g na maszynie", sets: "4", reps: "10-15" }, { name: "Uginanie n√≥g", sets: "4", reps: "10-15" }, { name: "Wspiƒôcia na palce", sets: "4", reps: "10-15" }] }, { day: 4, name: "Brzuch + Cardio", exercises: [{ name: "Plank", sets: "3", reps: "1 min" }, { name: "Brzuszki", sets: "3", reps: "20" }, { name: "Russian twist", sets: "3", reps: "20" }, { name: "Cardio (rower/bieg)", sets: "1", reps: "20-30 min" }] }, { day: 5, name: "Barki", mainLift: "Wyciskanie hantli nad g≈Çowƒô", exercises: [{ name: "Wyciskanie hantli nad g≈Çowƒô", sets: "4", reps: "10-15", p: 0.50 }, { name: "Unoszenie bokiem", sets: "4", reps: "10-15", p: 0.25 }, { name: "Face pulls", sets: "4", reps: "10-15" }, { name: "Szrugsy", sets: "4", reps: "10-15" }] }, { day: 6, name: "Full Body (obwodowy)", exercises: [{ name: "Pompki", sets: "4", reps: "15" }, { name: "Przysiady", sets: "4", reps: "15" }, { name: "Burpees", sets: "4", reps: "15" }, { name: "PodciƒÖganie", sets: "4", reps: "max" }, { name: "Mountain climbers", sets: "4", reps: "30s" }] }, { day: 0, name: "Odpoczynek", exercises: [] } ],
            mass: [ { day: 1, name: "Klatka + Triceps", mainLift: "Wyciskanie sztangi p≈Çasko", exercises: [{ name: "Wyciskanie sztangi p≈Çasko", sets: "4-5", reps: "6-10", p: 0.80 }, { name: "Wyciskanie hantli skos", sets: "4-5", reps: "6-10", p: 0.65 }, { name: "Rozpiƒôtki", sets: "4-5", reps: "6-10", p: 0.40 }, { name: "Wyciskanie francuskie", sets: "4-5", reps: "6-10" }, { name: "Pompki w podporze ty≈Çem", sets: "4-5", reps: "6-10" }] }, { day: 2, name: "Plecy + Biceps", mainLift: "Martwy ciƒÖg", exercises: [{ name: "Martwy ciƒÖg", sets: "4-5", reps: "6-10", p: 0.80 }, { name: "Wios≈Çowanie hantlami", sets: "4-5", reps: "6-10", p: 0.60 }, { name: "PodciƒÖganie", sets: "4-5", reps: "6-10" }, { name: "Uginanie ramion ze sztangƒÖ", sets: "4-5", reps: "6-10", p: 0.40 }, { name: "Koncentraty", sets: "4-5", reps: "6-10" }] }, { day: 3, name: "Nogi", mainLift: "Przysiady", exercises: [{ name: "Przysiady", sets: "4-5", reps: "6-10", p: 0.80 }, { name: "Wykroki z hantlami", sets: "4-5", reps: "6-10", p: 0.50 }, { name: "Suwnica", sets: "4-5", reps: "6-10", p: 1.20 }, { name: "≈ªurawie", sets: "4-5", reps: "6-10" }, { name: "Wspiƒôcia na palce", sets: "4-5", reps: "6-10" }] }, { day: 4, name: "Odpoczynek / Brzuch", exercises: [] }, { day: 5, name: "Barki", mainLift: "Wyciskanie ≈ºo≈Çnierskie", exercises: [{ name: "Wyciskanie ≈ºo≈Çnierskie", sets: "4-5", reps: "6-10", p: 0.60 }, { name: "Arnoldki", sets: "4-5", reps: "6-10", p: 0.45 }, { name: "Unoszenie na boki", sets: "4-5", reps: "6-10", p: 0.25 }, { name: "Tylny akton linkami", sets: "4-5", reps: "6-10" }] }, { day: 6, name: "Full Body", exercises: [{ name: "Thrusters", sets: "4-5", reps: "6-10" }, { name: "Przysiady przednie", sets: "4-5", reps: "6-10" }, { name: "Pompki na porƒôczach", sets: "4-5", reps: "6-10" }, { name: "Wios≈Çowanie sztangƒÖ", sets: "4-5", reps: "6-10" }, { name: "Skakanka", sets: "4-5", reps: "2 min" }] }, { day: 0, name: "Odpoczynek", exercises: [] } ],
            home: [ { day: 1, name: "Klatka + Triceps (Dom)", exercises: [{ name: "Pompki klasyczne", sets: "4", reps: "15-20" }, { name: "Pompki z nogami na podwy≈ºszeniu", sets: "4", reps: "15-20" }, { name: "Dipy na krze≈õle", sets: "4", reps: "15-20" }, { name: "Pompki wƒÖskie", sets: "4", reps: "15-20" }] }, { day: 2, name: "Plecy + Biceps (Dom)", exercises: [{ name: "PodciƒÖganie pod sto≈Çem", sets: "4", reps: "15-20" }, { name: "Uginanie z plecakiem", sets: "4", reps: "15-20" }, { name: "Supermany", sets: "4", reps: "15-20" }, { name: "Wios≈Çowanie rƒôcznikiem", sets: "4", reps: "15-20" }] }, { day: 3, name: "Nogi (Dom)", exercises: [{ name: "Przysiady", sets: "4", reps: "15-20" }, { name: "Wykroki", sets: "4", reps: "15-20" }, { name: "Przysiady sumo", sets: "4", reps: "15-20" }, { name: "Wspiƒôcia na palce", sets: "4", reps: "15-20" }] }, { day: 4, name: "Brzuch (Dom)", exercises: [{ name: "Brzuszki", sets: "4", reps: "20" }, { name: "Plank", sets: "4", reps: "1 min" }, { name: "Russian twist", sets: "4", reps: "20" }, { name: "No≈ºyce", sets: "4", reps: "20" }] }, { day: 5, name: "Barki (Dom)", exercises: [{ name: "Pompki szczupakowe (Pike push-up)", sets: "4", reps: "15-20" }, { name: "Unoszenie ramion z butelkami wody", sets: "4", reps: "15-20" }, { name: "KrƒÖ≈ºenia ramion", sets: "4", reps: "30s" }] }, { day: 6, name: "Full Body (Dom)", exercises: [{ name: "Burpees", sets: "4", reps: "15" }, { name: "Mountain climbers", sets: "4", reps: "30s" }, { name: "Pajacyki", sets: "4", reps: "30s" }, { name: "Przysiady z wyskokiem", sets: "4", reps: "15" }] }, { day: 0, name: "Odpoczynek", exercises: [] } ],
            maintain: [ { day: 1, name: "Full Body A", mainLift: "Przysiady ze sztangƒÖ", exercises: [{ name: "Przysiady ze sztangƒÖ", sets: "5", reps: "5", p: 0.75 }, { name: "Wyciskanie sztangi poziomo", sets: "5", reps: "5", p: 0.75 }, { name: "Wios≈Çowanie sztangƒÖ", sets: "5", reps: "5", p: 0.60 }, { name: "Wyciskanie hantli nad g≈Çowƒô", sets: "3", reps: "8-12" }, { name: "Uginanie ramion ze sztangƒÖ", sets: "3", reps: "8-12" }] }, { day: 2, name: "Odpoczynek", exercises: [] }, { day: 3, name: "Full Body B", mainLift: "Martwy ciƒÖg klasyczny", exercises: [{ name: "Martwy ciƒÖg klasyczny", sets: "5", reps: "5", p: 0.75 }, { name: "PodciƒÖganie na drƒÖ≈ºku", sets: "3", reps: "max" }, { name: "Dipy (pompki na porƒôczach)", sets: "3", reps: "max" }, { name: "Wykroki z hantlami", sets: "3", reps: "10-15" }, { name: "Unoszenie n√≥g w zwisie", sets: "3", reps: "15-20" }] }, { day: 4, name: "Odpoczynek", exercises: [] }, { day: 5, name: "Full Body C", mainLift: "Wyciskanie ≈ºo≈Çnierskie", exercises: [{ name: "Wyciskanie ≈ºo≈Çnierskie", sets: "5", reps: "5", p: 0.60 }, { name: "Przysiad bu≈Çgarski", sets: "3", reps: "10-12" }, { name: "Wios≈Çowanie hantlƒÖ", sets: "3", reps: "8-12" }, { name: "Pompki", sets: "3", reps: "max" }, { name: "Face pulls", sets: "3", reps: "15-20" }] }, { day: 6, name: "Cardio & Brzuch", exercises: [{ name: "Cardio (bie≈ºnia/rower)", sets: "1", reps: "20-30 min" }, { name: "Plank", sets: "3", reps: "1 min" }, { name: "Russian Twist", sets: "3", reps: "20" }, { name: "Allahy (Cable Crunches)", sets: "3", reps: "15" }] }, { day: 0, name: "Odpoczynek", exercises: [] } ]
        };

        const regularityLevels = [ { streak: 0, name: "Zagubiony Szczeniak", icon: 'üêæ' }, { streak: 1, name: "Szczeniak Mops", icon: 'üê∂' }, { streak: 3, name: "M≈Çody Biegacz", icon: 'üêï' }, { streak: 7, name: "Kanapowy Atleta", icon: 'üõãÔ∏è' }, { streak: 14, name: "Podw√≥rkowy Si≈Çacz", icon: 'üß±' }, { streak: 21, name: "Stra≈ºnik Chrupk√≥w", icon: 'üçñ' }, { streak: 30, name: "Paker z Parku", icon: 'üå≥' }, { streak: 45, name: "Mopsinator", icon: 'ü§ñ' }, { streak: 60, name: "Lord Ciƒô≈ºar√≥w", icon: 'üëë' }, { streak: 75, name: "Arcymops Imperator", icon: 'üèÜ' }, { streak: 90, name: "Legenda Si≈Çowni", icon: 'üî•' } ];
        const getRegularityLevel = (streak) => { return [...regularityLevels].reverse().find(level => streak >= level.streak) || regularityLevels[0]; };
        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        const dateDiffInDays = (a, b) => { const _MS_PER_DAY = 1000 * 60 * 60 * 24; const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate()); const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate()); return Math.floor((utc2 - utc1) / _MS_PER_DAY); };

        // --- Components ---
        const PugCharacter = () => ( <div className="flex justify-center items-center p-4 h-48"> <div className="relative w-40 h-40 animate-bounce-slow"> <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-20 h-12 bg-orange-300 border-4 border-stone-900 rounded-t-lg z-0"></div> <div className="absolute top-4 left-1/2 -translate-x-1/2 w-28 h-24 bg-orange-300 border-4 border-stone-900 rounded-lg z-10"> <div className="absolute inset-x-4 top-6 h-14 bg-amber-800 rounded"> <div className="absolute top-3 left-4 w-6 h-6 bg-white rounded-full border-2 border-stone-900 flex justify-center items-center"><div className="w-2 h-2 bg-stone-900 rounded-full"></div></div> <div className="absolute top-3 right-4 w-6 h-6 bg-white rounded-full border-2 border-stone-900 flex justify-center items-center"><div className="w-2 h-2 bg-stone-900 rounded-full"></div></div> <div className="absolute bottom-4 left-1/2 -translate-x-1/2 w-5 h-4 bg-stone-900 rounded-sm"></div> <div className="absolute bottom-2 left-1/2 -translate-x-1/2 w-8 h-1 bg-stone-900 rounded-full"></div> </div> </div> <div className="absolute top-2 left-6 w-8 h-10 bg-amber-800 border-4 border-stone-900 rounded-l-lg rounded-b-lg -rotate-12 z-20"></div> <div className="absolute top-2 right-6 w-8 h-10 bg-amber-800 border-4 border-stone-900 rounded-r-lg rounded-b-lg rotate-12 z-20"></div> </div> </div> );
        const MessageBox = ({ message, streak, level }) => ( <div className="bg-white p-4 rounded-lg shadow-md border-4 border-stone-900 relative min-h-[90px] w-full max-w-sm mx-auto pixel-corners"> <div className="flex items-center justify-center text-center"> <p className="text-stone-800 font-mono text-lg md:text-xl">{message}</p> </div> <div className="absolute -bottom-5 left-1/2 -translate-x-1/2 w-11/12"> <div className="bg-amber-800 text-white font-mono text-xs px-3 py-1 border-2 border-stone-900 rounded-full flex items-center justify-between"> <div className="flex items-center gap-1"> <Flame size={12} className="text-orange-400"/> <span>{streak} dni</span> </div> <div className="flex items-center gap-2"> <span>{level.icon}</span> <span className="truncate">{level.name}</span> </div> </div> </div> <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-b-8 border-b-white" style={{ clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)' }}></div> </div> );
        const WorkoutDetailView = ({ workout, userData, onBack, onComplete }) => { 
            const [oneRM, setOneRM] = useState(userData.oneRM?.[workout.mainLift] || 100); 
            const [checkedState, setCheckedState] = useState(new Array(workout.exercises.length).fill(false)); 
            const allChecked = useMemo(() => checkedState.every(Boolean), [checkedState]); 
            
            const handleCheckboxChange = (position) => { const updatedCheckedState = checkedState.map((item, index) => index === position ? !item : item); setCheckedState(updatedCheckedState); }; 
            const calculateWeight = (percentage) => { if (!percentage || !oneRM || oneRM <= 0) return ''; const workingWeight = Math.round((oneRM * percentage) / 2.5) * 2.5; return `~${workingWeight} kg`; }; 
            
            return ( 
            <div className="w-full animate-fade-in p-1 md:p-4"> 
                <button onClick={() => onBack(workout.mainLift, oneRM)} className="pixel-button bg-orange-500 text-white mb-4 flex items-center gap-2"><ArrowLeft size={20}/> Wr√≥ƒá</button> 
                <div className="bg-white p-4 border-4 border-stone-900 pixel-corners"> 
                    <h2 className="font-header text-lg text-stone-900 text-center mb-2">{workout.name}</h2> 
                    {workout.mainLift && ( <div className="mb-4 font-mono text-stone-800"> <label className="block text-center">Tw√≥j max w: <span className="font-bold">{workout.mainLift}</span></label> <input type="number" value={oneRM} onChange={(e) => setOneRM(Number(e.target.value))} className="w-full p-1 border-2 border-stone-900 text-center" /> </div> )} 
                    <ul className="space-y-3"> {workout.exercises.map((exercise, index) => ( <li key={index} className="flex items-center gap-3 font-mono text-base md:text-lg cursor-pointer" onClick={() => handleCheckboxChange(index)}> <div>{checkedState[index] ? <CheckSquare className="text-green-500"/> : <Square className="text-stone-400"/>}</div> <div className="flex-grow"> <span className={`${checkedState[index] ? 'line-through text-stone-400' : 'text-stone-800'}`}>{exercise.name}</span> <span className="text-sm font-bold text-stone-500 block">({exercise.sets}x{exercise.reps}) {calculateWeight(exercise.p)}</span> </div> </li> ))} </ul> 
                    <button onClick={() => onComplete(workout)} disabled={!allChecked} className="pixel-button bg-green-500 text-white w-full mt-6 disabled:bg-stone-500 disabled:shadow-none disabled:translate-y-1">Zako≈Ñcz Trening</button> 
                </div> 
            </div> 
            ); 
        };
        const ProgressView = ({ userData, onBack, onUndoWorkout }) => { const [currentDate, setCurrentDate] = useState(new Date()); const history = userData.history || []; const lastWorkout = history.length > 0 ? history[history.length - 1] : null; const generateCalendar = () => { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7; const blanks = Array(firstDayOfMonth).fill(null); const days = Array.from({ length: daysInMonth }, (_, i) => i + 1); return [...blanks, ...days].map((day, index) => { if (!day) return <div key={`blank-${index}`} className="w-10 h-10 border-2 border-stone-300"></div>; const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const isWorkoutDay = history.some(h => h.date === dateStr); const isToday = dateStr === getTodayDateString(); return ( <div key={day} className={`w-10 h-10 flex items-center justify-center border-2 ${isWorkoutDay ? 'bg-green-400 border-green-700' : 'bg-stone-100 border-stone-300'} ${isToday ? 'ring-2 ring-orange-500' : ''}`}> <span className={`font-mono font-bold ${isWorkoutDay ? 'text-white' : 'text-stone-700'}`}>{day}</span> </div> ); }); }; const changeMonth = (delta) => { setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + delta, 1)); }; return ( <div className="w-full animate-fade-in p-1 md:p-4"> <button onClick={onBack} className="pixel-button bg-orange-500 text-white mb-4 flex items-center gap-2"><ArrowLeft size={20}/> Wr√≥ƒá</button> <div className="bg-white p-4 border-4 border-stone-900 pixel-corners text-stone-800"> <h2 className="font-header text-lg text-stone-900 mb-4 text-center">Kalendarz Postƒôp√≥w</h2> <div className="flex justify-between items-center mb-2"> <button onClick={() => changeMonth(-1)} className="pixel-button text-sm">{'<'}</button> <span className="font-mono font-bold">{currentDate.toLocaleString('pl-PL', { month: 'long', year: 'numeric' })}</span> <button onClick={() => changeMonth(1)} className="pixel-button text-sm">{'>'}</button> </div> <div className="grid grid-cols-7 gap-1 justify-items-center"> {['PN', 'WT', '≈öR', 'CZ', 'PT', 'SO', 'ND'].map(d => <div key={d} className="font-mono font-bold text-xs">{d}</div>)} {generateCalendar()} </div> {lastWorkout && lastWorkout.date === getTodayDateString() && ( <button onClick={() => onUndoWorkout(lastWorkout)} className="pixel-button bg-red-500 text-white w-full mt-4 flex items-center justify-center gap-2"> <Undo2 size={16}/> Cofnij dzisiejszy trening </button> )} </div> </div> ); };
        const GoalSelectionView = ({ onGoalSelect }) => ( <div className="w-full animate-fade-in p-4 text-center"> <PugCharacter /> <h2 className="font-header text-xl text-stone-900 mb-4">Wybierz sw√≥j g≈Ç√≥wny cel!</h2> <p className="font-mono text-stone-800 mb-6">Mopsio dopasuje do niego plan treningowy.</p> <div className="space-y-4"> <button onClick={() => onGoalSelect('mass')} className="pixel-button bg-red-500 text-white w-full">Budowa Masy</button> <button onClick={() => onGoalSelect('reduction')} className="pixel-button bg-blue-500 text-white w-full">Redukcja T≈Çuszczu</button> <button onClick={() => onGoalSelect('maintain')} className="pixel-button bg-amber-500 text-white w-full">Utrzymanie Wagi</button> </div> </div> );

        function App() {
            // --- State Management with localStorage ---
            const [userData, setUserData] = useState(() => {
                try {
                    const savedData = localStorage.getItem('mopsGymUserData');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        // Streak penalty logic on load
                        const today = new Date();
                        const lastWorkoutDate = parsedData.lastWorkoutDate ? new Date(parsedData.lastWorkoutDate) : null;
                        if (lastWorkoutDate && dateDiffInDays(lastWorkoutDate, today) > 1) {
                            const penalty = dateDiffInDays(lastWorkoutDate, today) - 1;
                            parsedData.streak = Math.max(0, (parsedData.streak || 0) - penalty);
                        }
                        return parsedData;
                    }
                } catch (error) {
                    console.error("B≈ÇƒÖd odczytu danych z localStorage", error);
                }
                return null;
            });

            const [message, setMessage] = useState("Wybierz cel, a Mops przygotuje dla Ciebie plan!");
            const [activePlan, setActivePlan] = useState('mass');
            const [selectedWorkout, setSelectedWorkout] = useState(null);
            
            // --- Determine current view based on userData ---
            const [currentView, setCurrentView] = useState(() => userData ? 'main' : 'goalSelection');

            // --- Persist userData to localStorage on change ---
            useEffect(() => {
                try {
                    if (userData) {
                        localStorage.setItem('mopsGymUserData', JSON.stringify(userData));
                        setActivePlan(userData.goal); // Sync active plan with user data
                    }
                } catch (error) {
                    console.error("B≈ÇƒÖd zapisu danych do localStorage", error);
                }
            }, [userData]);
            
            // --- Set initial message on load ---
            useEffect(() => {
                if(userData) {
                    const workoutDone = userData.history?.some(h => h.date === getTodayDateString());
                    if (workoutDone) {
                        setMessage(getRandomItem(messages.congrats));
                    } else {
                        const dayOfWeek = new Date().getDay();
                        const workoutToday = trainingPlans[userData.goal]?.find(w => w.day === dayOfWeek);
                        setMessage(workoutToday && workoutToday.exercises.length > 0 ? `Dzi≈õ ${workoutToday.name}! Do dzie≈Ça!` : "Dzi≈õ dzie≈Ñ wolny! Czas na chrupki!");
                    }
                }
            }, []);


            const isWorkoutDoneToday = useMemo(() => {
                if (!userData) return false;
                const today = getTodayDateString();
                return userData.history && userData.history.some(h => h.date === today);
            }, [userData]);

            const handleGoalSelection = (goal) => {
                const newUserData = {
                    goal: goal,
                    history: [],
                    xp: 0,
                    workoutCounts: {},
                    oneRM: {},
                    streak: 0,
                    lastWorkoutDate: null
                };
                setUserData(newUserData);
                setCurrentView('main');
                setMessage("Super! Tw√≥j plan jest gotowy. Do dzie≈Ça!");
            };
            
            const handleWorkoutSelect = (workout) => {
                setSelectedWorkout(workout);
                setCurrentView('workout');
            };

            const handleBackFromWorkout = (mainLift, oneRM) => {
                if (mainLift && oneRM) {
                    setUserData(prev => ({
                        ...prev,
                        oneRM: { ...prev.oneRM, [mainLift]: oneRM }
                    }));
                }
                setCurrentView('main');
            };

            const handleCompleteWorkout = (workout) => {
                if (isWorkoutDoneToday || !userData) return;
                
                setCurrentView('main');
                setMessage(getRandomItem(messages.congrats));

                const today = new Date();
                const todayStr = getTodayDateString();
                
                setUserData(prev => {
                    const lastWorkoutDate = prev.lastWorkoutDate ? new Date(prev.lastWorkoutDate) : null;
                    let newStreak = prev.streak || 0;

                    if (lastWorkoutDate) {
                        const daysDiff = dateDiffInDays(lastWorkoutDate, today);
                        if (daysDiff === 1) {
                            newStreak += 1; // Consecutive day
                        } else if (daysDiff > 1) {
                            newStreak = 1; // Streak broken, start new one
                        }
                        // if daysDiff is 0, do nothing to streak
                    } else {
                        newStreak = 1; // First workout
                    }

                    const newHistoryEntry = { date: todayStr, type: workout.name };
                    const newHistory = [...(prev.history || []), newHistoryEntry];
                    const newWorkoutCounts = { ...(prev.workoutCounts || {}) };
                    newWorkoutCounts[workout.name] = (newWorkoutCounts[workout.name] || 0) + 1;
                    
                    return {
                        ...prev,
                        history: newHistory,
                        xp: (prev.xp || 0) + 1,
                        workoutCounts: newWorkoutCounts,
                        streak: newStreak,
                        lastWorkoutDate: todayStr
                    };
                });
            };
            
            const handleUndoWorkout = (workoutToUndo) => {
                if (!userData || !workoutToUndo) return;

                setMessage(getRandomItem(messages.motivation));
                setCurrentView('main');

                setUserData(prev => {
                    const newHistory = prev.history.slice(0, -1);
                    const newWorkoutCounts = { ...prev.workoutCounts };
                    if (newWorkoutCounts[workoutToUndo.type] > 0) {
                        newWorkoutCounts[workoutToUndo.type] -= 1;
                    }
                    
                    // Revert streak logic is complex, a simple decrement is a good approximation
                    const newStreak = Math.max(0, (prev.streak || 0) - 1);
                    const newLastWorkoutDate = newHistory.length > 0 ? newHistory[newHistory.length - 1].date : null;

                    return {
                        ...prev,
                        history: newHistory,
                        xp: Math.max(0, (prev.xp || 0) - 1),
                        workoutCounts: newWorkoutCounts,
                        streak: newStreak,
                        lastWorkoutDate: newLastWorkoutDate
                    };
                });
            };

            const renderMainContent = () => {
                const dayOfWeek = new Date().getDay();
                const currentStreak = userData?.streak || 0;
                const currentLevel = getRegularityLevel(currentStreak);

                return (
                    <>
                        <PugCharacter />
                        <MessageBox message={message} streak={currentStreak} level={currentLevel} />
                        <div className="mt-8 animate-fade-in text-center">
                            <div className="flex justify-center flex-wrap gap-2 mb-4">
                                <button onClick={() => setActivePlan('mass')} className={`pixel-button text-xs ${activePlan === 'mass' ? 'bg-red-500 text-white' : 'bg-stone-300 text-stone-800'}`}>Masa</button>
                                <button onClick={() => setActivePlan('reduction')} className={`pixel-button text-xs ${activePlan === 'reduction' ? 'bg-blue-500 text-white' : 'bg-stone-300 text-stone-800'}`}>Redukcja</button>
                                <button onClick={() => setActivePlan('maintain')} className={`pixel-button text-xs ${activePlan === 'maintain' ? 'bg-amber-500 text-white' : 'bg-stone-300 text-stone-800'}`}>Utrzymaj</button>
                                <button onClick={() => setActivePlan('home')} className={`pixel-button text-xs ${activePlan === 'home' ? 'bg-green-500 text-white' : 'bg-stone-300 text-stone-800'}`}>W Domu</button>
                            </div>

                            {isWorkoutDoneToday ? (
                                <h2 className="font-bold text-xl mb-4 font-mono text-stone-900">Odpoczywaj!</h2>
                            ) : (
                                <div>
                                    <h3 className="font-mono text-lg text-stone-800 mb-2">Wybierz trening:</h3>
                                    <div className="space-y-2">
                                        {trainingPlans[activePlan].filter(w => w.exercises && w.exercises.length > 0).map(workout => (
                                            <button 
                                                key={`${activePlan}-${workout.day}`} 
                                                onClick={() => handleWorkoutSelect(workout)} 
                                                className={`pixel-button w-full ${workout.day === dayOfWeek ? 'bg-orange-400 text-stone-900' : 'bg-stone-300 text-stone-800'}`}
                                            >
                                                {workout.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </>
                );
            };
            
            const renderView = () => {
                switch (currentView) {
                    case 'goalSelection':
                        return <GoalSelectionView onGoalSelect={handleGoalSelection} />;
                    case 'workout':
                        return <WorkoutDetailView workout={selectedWorkout} userData={userData} onBack={handleBackFromWorkout} onComplete={handleCompleteWorkout} />;
                    case 'progress':
                        return <ProgressView userData={userData} onBack={() => setCurrentView('main')} onUndoWorkout={handleUndoWorkout} />;
                    case 'main':
                    default:
                        if (!userData) return <GoalSelectionView onGoalSelect={handleGoalSelection} />;
                        return renderMainContent();
                }
            };

            return (
                <div className="bg-stone-900 min-h-screen font-sans flex flex-col items-center justify-center p-2 md:p-4 text-white">
                    <div className="w-full max-w-md mx-auto bg-orange-200 rounded-2xl shadow-xl border-8 border-stone-900 p-2 md:p-4">
                        <header className="text-center mb-2 md:mb-4 relative h-10">
                            <h1 className="text-xl md:text-2xl font-header text-stone-900 drop-shadow-sm">MopsGym</h1>
                            <div className="absolute top-0 right-0 flex gap-2">
                               {currentView === 'main' && userData && (
                                   <>
                                    <button onClick={() => setCurrentView('progress')} className="pixel-button bg-blue-500 text-white !p-2"><BarChart2 size={20}/></button>
                                   </>
                               )}
                            </div>
                        </header>
                        <main>{renderView()}</main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
</body>
</html>
